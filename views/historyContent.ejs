<%- include('partials/header', { title: `${list.listname} • History` }) %>

<div class="page-head">
  <div>
    <h1 class="h1"><%= list.listname %></h1>
    <p class="muted">Created: <%= list.created_at ? new Date(list.created_at).toLocaleString() : "Unknown" %></p>
  </div>
  <div class="page-actions">
    <a class="btn btn-ghost" href="/history">Back to history</a>
    <button id="showAddItemBtn" class="btn" type="button">Add item</button>
  </div>
</div>

<div>
  <div class="card" style="margin-bottom: 20px;">
    <div class="card-body">
        <div>
          <h2 class="h2">Total</h2>
          <p class="muted">Sum of all items in this list.</p>
        </div>
        <div class="h2">GH₵ <%= (totalSum || 0).toFixed(2) %></div>
    </div>
  </div>

  <!-- ADD ITEM FORM -->
  <div id="addItemForm" class="card" style="display:none;">
    <div class="card-body">
      <h2 class="h2">Add item</h2>
      <form class="form" action="/history/additem" method="POST">
        <input type="hidden" name="listname" value="<%= list.listname %>" />

        <div class="field">
          <label class="label" for="new_itemname">Item</label>
          <input class="input" id="new_itemname" type="text" name="itemname" placeholder="Item name" required />
        </div>

        <div class="form-row">
          <div class="field">
            <label class="label" for="new_quantity">Quantity</label>
            <input class="input" id="new_quantity" type="number" name="quantity" placeholder="Quantity" min="0" step="1" required />
          </div>
          <div class="field">
            <label class="label" for="new_price">Price</label>
            <input class="input" id="new_price" type="number" name="price" step="0.01" placeholder="Price" min="0" required />
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Add</button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="page-head">
        <div>
          <h2 class="h2">Items</h2>
          <p class="muted">Update values inline and save all changes at once.</p>
        </div>
        <div class="page-actions">
          <form action="/history/removeallitems" method="POST" onsubmit="return confirm('Remove ALL items?');">
            <input type="hidden" name="listname" value="<%= list.listname %>" />
            <button class="btn btn-danger" type="submit">Remove all</button>
          </form>
        </div>
      </div>

      <% if (!list.items || list.items.length === 0) { %>
        <div class="alert">This list is empty.</div>
      <% } else { %>
        <!-- UPDATE ALL ITEMS -->
        <form action="/history/updateallitems" method="POST">
          <input type="hidden" name="listname" value="<%= list.listname %>" />

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="td-center">Quantity</th>
                  <th class="td-right">Price</th>
                  <th class="td-right">Total</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody>
                <% list.items.forEach((item, index) => { %>
                  <tr>
                    <td>
                      <input type="hidden" name="items[<%= index %>][id]" value="<%= item.id %>" />
                      <input class="input" type="text" name="items[<%= index %>][itemname]" value="<%= item.itemname %>" required />
                    </td>
                    <td class="td-center">
                      <input class="input" type="number" name="items[<%= index %>][quantity]" value="<%= item.quantity %>" min="0" step="1" required />
                    </td>
                    <td class="td-right">
                      <input class="input" type="number" name="items[<%= index %>][price]" step="0.01" value="<%= item.price %>" min="0" required />
                    </td>
                    <td class="td-right">GH₵ <%= item.total ? item.total.toFixed(2) : "0.00" %></td>
                    <td>
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        onclick="removeItem('<%= item.id %>', '<%= list.listname %>')"
                      >Remove</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <div class="spacer-12"></div>
          <button type="submit" class="btn btn-primary">Update all</button>
        </form>
      <% } %>
    </div>
  </div>
</div>

<script>
  const addBtn = document.getElementById("showAddItemBtn");
  const addForm = document.getElementById("addItemForm");

  if (addBtn && addForm) {
    addBtn.addEventListener("click", () => {
      addForm.style.display = addForm.style.display === "none" ? "block" : "none";
    });
  }

  // AJAX remove (no nested form issues)
  function removeItem(id, listname) {
    if (!confirm("Remove this item?")) return;

    fetch("/history/deleteitem", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `id=${id}&listname=${encodeURIComponent(listname)}`
    }).then(() => location.reload());
  }
</script>

<%- include('partials/footer') %>
